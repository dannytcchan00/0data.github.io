<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>中環碼頭多航線渡輪班次</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #121212;
    color: #e0e0e0;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 100vh;
    width: 100%;
  }
  .pier-info-popup {
    background: rgba(20, 20, 20, 0.9);
    color: #eee;
    padding: 6px 8px 12px 8px;
    border-radius: 6px;
    max-width: 200px;
    width: 200px;
    font-size: 9px;
    user-select: none;
    box-sizing: border-box;
    border: 2px solid transparent;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.8);
  }
  .pier-info-popup h4 {
    margin: 0 0 0px 0;
    color: #bb86fc;
    font-weight: 700;
    font-size: 1.3em;
  }
  .route-section {
    margin-bottom: 18px;
  }
  .route-section h5 {
    margin: 0 0 6px 0;
    font-weight: 600;
    font-size: 1.1em;
    color: #03dac6;
  }
  .schedule-row {
    display: grid;
    grid-template-columns: 30% 30% 40%;
    gap: 6px;
    padding: 2px 0;
    border-bottom: 1px solid #444;
    align-items: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .schedule-row:last-child {
    border-bottom: none;
  }
  .schedule-row span.time {
    font-weight: bold;
    color: #bb86fc;
    text-align: left;
  }
  .schedule-row span.destination {
    color: #80cbc4;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .schedule-row span.countdown {
    text-align: center;
    font-style: italic;
    color: #eee;
  }
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
<script>
const { DateTime } = luxon;

const piers = {
  central: { lat: 22.2873, lng: 114.1587, name: "中環碼頭", color: "#bb86fc" },
  pengchau: { lat: 22.2880, lng: 114.0355, name: "坪洲碼頭", color: "#03dac6" },
  sokkwu: { lat: 22.205679, lng: 114.130797, name: "索罟灣碼頭", color: "#ff9800" },
  yungshue: { lat: 22.226127, lng: 114.108399, name: "榕樹灣碼頭", color: "#4caf50" },
  cheungchau: { lat: 22.2103, lng: 114.0305, name: "長洲碼頭", color: "#ff5722" },
  muiwo: { lat: 22.26509, lng: 114.0003, name: "梅窩碼頭", color: "#009688" }
};

// 班次時間 表（24小時制）
const schedules = {
  centralToPengChauWeekday: ["03:00","07:00","07:40","08:00","08:30","09:15","10:00","10:45","11:30","12:15","13:00","13:45","14:30","15:15","16:10"],
  centralToPengChauHoliday: ["03:00","07:00","07:50","08:40","09:30","10:20","11:05","12:00","12:45","13:40","14:30","15:20","16:10","17:00","17:50"],
  pengChauToCentralWeekday: ["03:40","05:30","06:15","07:00","07:25","07:45","08:20","08:35","09:15","10:00","10:45","11:30","12:15","13:00","13:45","14:30","15:15","16:00","16:55","17:25","18:15","18:50","19:45","20:30","21:15","22:05","22:45","23:30"],
  pengChauToCentralHoliday: ["03:40","05:30","06:30","07:00","07:50","08:40","09:30","10:20","11:10","11:50","12:50","13:30","14:30","15:20","16:10","17:00","17:50","18:40","19:30","20:20","21:15","22:00","22:50","23:35"],
  
  centralToSokKwuWanWeekday: ["07:20","08:35","10:20","11:50","13:50","15:20","16:50","18:45","20:20","21:50","23:30"],
  centralToSokKwuWanHoliday: ["07:20","08:35","10:20","11:50","12:50","13:50","14:35","15:20","16:05","16:50","17:35","18:45","19:20","20:20","21:50","23:30"],
  sokKwuWanToCentralWeekday: ["06:45","08:00","09:35","11:05","12:40","14:35","16:05","17:35","19:35","21:05","22:40"],
  sokKwuWanToCentralHoliday: ["06:45","08:00","09:35","11:05","12:40","13:50","14:35","15:20","16:05","16:50","17:35","18:35","19:35","20:20","21:05","22:40"],
  
  centralToYungShueWanWeekday: ["02:30","06:30","07:00","07:30","07:50","08:10","08:30","08:50","09:10","09:30","10:10","11:00","12:00","13:00","13:45","14:30","15:15","15:50","16:30","17:20","17:40","18:00","18:20","18:40","19:00","19:30","20:00","20:30","21:00","21:30","22:30","23:30","00:30"],
  centralToYungShueWanHoliday: ["02:30","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:30","22:30","23:30","00:30"],
  yungShueWanToCentralWeekday: ["05:30","06:20","06:40","07:00","07:20","07:40","08:00","08:20","08:40","09:00","09:20","09:40","10:30","11:20","12:00","13:00","13:45","14:30","15:15","16:00","16:30","17:15","17:50","18:10","18:30","18:50","19:20","20:00","20:30","21:30","22:30","23:30"],
  yungShueWanToCentralHoliday: ["05:30","06:40","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:30","22:30","23:30"],
  
  centralToCheungChauWeekday: ["00:30","01:30","04:15","06:10","07:00","07:40","08:00","08:40","09:00","09:45","10:15","10:45","11:15","11:45","12:15","12:45","13:15","13:45","14:15","14:45","15:15","15:45","16:15","16:45","17:15","17:45","18:15","18:45","19:15","19:45","20:15","20:45","21:15","21:45","22:15","22:45","23:15","23:55"],
  centralToCheungChauHoliday: ["00:30","01:30","04:15","06:10","07:00","07:40","08:00","08:40","09:00","09:45","10:15","10:45","11:15","11:45","12:15","12:45","13:15","13:45","14:15","14:45","15:15","15:45","16:15","16:45","17:15","17:45","18:15","18:45","19:15","19:45","20:15","20:45","21:15","21:45","22:15","22:45","23:15","23:55"],
  cheungChauToCentralWeekday: ["02:20","05:10","05:50","06:20","06:40","07:00","07:15","07:45","07:50","07:55","08:10","08:20","08:40","09:00","09:30","10:00","10:45","11:15","11:45","12:15","12:45","13:15","13:45","14:15","14:45","15:15","15:45","16:15","16:45","17:15","17:45","18:15","18:45","19:15","19:45","20:15","20:45","21:15","21:45","22:15","22:45"],
  cheungChauToCentralHoliday: ["02:20","05:10","05:50","06:20","06:40","07:00","07:15","07:45","07:50","07:55","08:10","08:20","08:40","09:00","09:30","10:00","10:45","11:15","11:45","12:15","12:45","13:15","13:45","14:15","14:45","15:15","15:45","16:15","16:45","17:15","17:45","18:15","18:45","19:15","19:45","20:15","20:45","21:15","21:45","22:15","22:45"],
  
  centralToMuiWoWeekday: ["00:30","03:00","06:10","06:50","07:10","07:40","08:30","09:00","09:50","10:30","11:10","11:50","12:30","13:10","13:50","14:30","15:10","15:50","16:30","17:20","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:30","23:30"],
  centralToMuiWoHoliday: ["00:30","03:00","06:10","06:50","07:10","07:40","08:30","09:00","09:50","10:30","11:10","11:50","12:30","13:10","13:50","14:30","15:10","15:50","16:30","17:20","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:30","23:30"],
  muiWoToCentralWeekday: ["03:40","05:55","06:20","06:30","07:00","07:10","07:20","07:50","08:05","08:30","08:45","09:40","10:00","10:40","11:30","12:10","12:50","13:30","14:10","14:50","15:30","16:10","16:50","17:30","18:10","18:40","19:30","20:30","21:30","22:40","23:30"],
  muiWoToCentralHoliday: ["03:40","05:55","06:20","06:30","07:00","07:10","07:20","07:50","08:05","08:30","08:45","09:40","10:00","10:40","11:20","12:00","12:40","13:20","14:00","14:40","15:20","16:00","16:40","17:20","18:00","18:40","19:20","20:00","20:40","21:20","22:00","22:50","23:30"]
};

function isHoliday() {
  const now = DateTime.now().setZone("Asia/Hong_Kong");
  return now.weekday === 7;
}

function getSchedule(pierKey, outbound = true) {
  const holiday = isHoliday();
  if (pierKey === "central") {
    if (outbound) {
      return [].concat(
        holiday ? schedules.centralToPengChauHoliday : schedules.centralToPengChauWeekday,
        holiday ? schedules.centralToSokKwuWanHoliday : schedules.centralToSokKwuWanWeekday,
        holiday ? schedules.centralToYungShueWanHoliday : schedules.centralToYungShueWanWeekday,
        holiday ? schedules.centralToCheungChauHoliday : schedules.centralToCheungChauWeekday,
        holiday ? schedules.centralToMuiWoHoliday : schedules.centralToMuiWoWeekday
      );
    } else {
      return [];
    }
  }
  if (pierKey === "pengchau") {
    return holiday ? schedules.pengChauToCentralHoliday : schedules.pengChauToCentralWeekday;
  }
  if (pierKey === "sokkwu") {
    return holiday ? schedules.sokKwuWanToCentralHoliday : schedules.sokKwuWanToCentralWeekday;
  }
  if (pierKey === "yungshue") {
    return holiday ? schedules.yungShueWanToCentralHoliday : schedules.yungShueWanToCentralWeekday;
  }
  if (pierKey === "cheungchau") {
    return holiday ? schedules.cheungChauToCentralHoliday : schedules.cheungChauToCentralWeekday;
  }
  if (pierKey === "muiwo") {
    return holiday ? schedules.muiWoToCentralHoliday : schedules.muiWoToCentralWeekday;
  }
  return [];
}

function getNextTwoTimes(schedule) {
  const now = DateTime.now().setZone("Asia/Hong_Kong");
  let futureTimes = [];
  for (const timeStr of schedule) {
    const [h, m] = timeStr.split(":").map(Number);
    let timeDt = now.set({ hour: h, minute: m, second: 0, millisecond: 0 });
    if (timeDt <= now) timeDt = timeDt.plus({ days: 1 });
    if (timeDt >= now) futureTimes.push({ time: timeStr, timeDt });
  }
  futureTimes.sort((a, b) => a.timeDt - b.timeDt);
  let nextTwo = futureTimes.slice(0, 2).map(t => t.time);
  if (nextTwo.length < 2) nextTwo = nextTwo.concat(schedule.slice(0, 2 - nextTwo.length));
  return nextTwo;
}

function countdownTo(timeStr) {
  const now = DateTime.now().setZone("Asia/Hong_Kong");
  const [h, m] = timeStr.split(":").map(Number);
  let target = now.set({ hour: h, minute: m, second: 0, millisecond: 0 });
  if (target <= now) target = target.plus({ days: 1 });
  const diff = target.diff(now, ["minutes", "seconds"]).toObject();
  return `${diff.minutes}分${Math.floor(diff.seconds)}秒`;
}

const map = L.map("map", { zoomControl: false }).setView([22.3, 114.1], 11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
  maxZoom: 18,
}).addTo(map);
L.control.zoom({ position: "bottomright" }).addTo(map);

// 中環碼頭資訊框
const centralInfoDiv = document.createElement("div");
centralInfoDiv.className = "pier-info-popup";
centralInfoDiv.style.backgroundColor = "rgba(20,20,20,0.9)";
centralInfoDiv.style.borderColor = piers.central.color;
centralInfoDiv.style.boxShadow = `0 0 15px ${piers.central.color}`;

L.marker([piers.central.lat, piers.central.lng], {
  icon: L.divIcon({ className: "", html: centralInfoDiv, iconAnchor: [0, 15] }),
  interactive: false,
}).addTo(map);

function updateCentralInfo() {
  while (centralInfoDiv.firstChild) centralInfoDiv.removeChild(centralInfoDiv.firstChild);

  const title = document.createElement("h4");
  title.textContent = piers.central.name;
  centralInfoDiv.appendChild(title);

  const destinations = ["坪洲", "索罟灣", "榕樹灣", "長洲", "梅窩"];
  // 根據整合時間表長度斷開各航線時間段
  let lengths = [
    schedules.centralToPengChauWeekday.length,
    schedules.centralToSokKwuWanWeekday.length,
    schedules.centralToYungShueWanWeekday.length,
    schedules.centralToCheungChauWeekday.length,
    schedules.centralToMuiWoWeekday.length
  ];
  const holiday = isHoliday();
  let start = 0;

  destinations.forEach((dest, idx) => {
    const section = document.createElement("div");
    section.className = "route-section";
    const header = document.createElement("h5");
    header.textContent = `前往${dest}`;
    section.appendChild(header);

    let scheduleList;
    if (dest === "坪洲") {
      scheduleList = holiday ? schedules.centralToPengChauHoliday : schedules.centralToPengChauWeekday;
    } else if (dest === "索罟灣") {
      scheduleList = holiday ? schedules.centralToSokKwuWanHoliday : schedules.centralToSokKwuWanWeekday;
    } else if (dest === "榕樹灣") {
      scheduleList = holiday ? schedules.centralToYungShueWanHoliday : schedules.centralToYungShueWanWeekday;
    } else if (dest === "長洲") {
      scheduleList = holiday ? schedules.centralToCheungChauHoliday : schedules.centralToCheungChauWeekday;
    } else if (dest === "梅窩") {
      scheduleList = holiday ? schedules.centralToMuiWoHoliday : schedules.centralToMuiWoWeekday;
    } else {
      scheduleList = [];
    }

    const nextTwo = getNextTwoTimes(scheduleList);
    nextTwo.forEach(time => {
      const div = document.createElement("div");
      div.className = "schedule-row";
      div.innerHTML = `<span class="time">${time}</span><span class="destination">${dest}</span><span class="countdown" data-time="${time}"></span>`;
      section.appendChild(div);
    });

    start += lengths[idx];
    centralInfoDiv.appendChild(section);
  });
}
updateCentralInfo();
setInterval(updateCentralInfo, 60000);

// 其他碼頭獨立顯示
const otherPiers = ["pengchau", "sokkwu", "yungshue", "cheungchau", "muiwo"];
otherPiers.forEach(key => {
  const pier = piers[key];
  L.circleMarker([pier.lat, pier.lng], {
    radius: 10, fillColor: pier.color, color: "#222", weight: 2,
    opacity: 1, fillOpacity: 0.9, interactive: false
  }).addTo(map);

  const infoDiv = document.createElement("div");
  infoDiv.className = "pier-info-popup";
  infoDiv.id = `pier-info-${key}`;
  infoDiv.style.backgroundColor = "rgba(20,20,20,0.9)";
  infoDiv.style.borderColor = pier.color;
  infoDiv.style.boxShadow = `0 0 15px ${pier.color}`;
  const infoIcon = L.divIcon({
    className: "",
    html: infoDiv,
    iconAnchor: [0, 15]
  });
  L.marker([pier.lat, pier.lng], { icon: infoIcon, interactive: false }).addTo(map);

  function updateInfo() {
    const schedule = getSchedule(key, true);
    const nextTwo = getNextTwoTimes(schedule);
    const destination = "中環";

    while (infoDiv.firstChild) infoDiv.removeChild(infoDiv.firstChild);
    const title = document.createElement("h4");
    title.textContent = pier.name;
    infoDiv.appendChild(title);

    nextTwo.forEach(time => {
      const div = document.createElement("div");
      div.className = "schedule-row";
      div.innerHTML = `<span class="time">${time}</span><span class="destination">${destination}</span><span class="countdown" data-time="${time}"></span>`;
      infoDiv.appendChild(div);
    });
    updateCountdowns();
  }
  updateInfo();
  setInterval(updateInfo, 60000);
});

function updateCountdowns() {
  document.querySelectorAll(".countdown").forEach(el => {
    const time = el.getAttribute("data-time");
    el.textContent = countdownTo(time);
  });
}
setInterval(updateCountdowns, 1000);
</script>
</body>
</html>
