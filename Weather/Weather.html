<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>香港氣象多功能地圖</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html,body { margin:0; padding:0; height:100%; background:#121212; font-family:Arial,sans-serif; }
#map { width: 100vw; height: 100vh; }
#header {
  position:absolute; top:10px; left:10px; z-index:1300;
  background:rgba(255,255,255,0.9); padding:6px 10px;
  border-radius:8px; font-weight:700; font-size:14px; color:#222;
  box-shadow:0 0 10px rgba(0,0,0,0.7); max-width:320px; min-width:150px;
  overflow-wrap:break-word; line-height:1.2; word-break: break-word;
  width: 320px;
}
#warning { margin:4px 0; }
#buttons {
  position:absolute; top:10px; right:10px; z-index:1300;
  display:flex; gap:8px;
}
#buttons button {
  background:#333; color:#fff; border:none; padding:6px 12px; border-radius:5px;
  cursor:pointer; font-weight:600; font-size:13px;
  transition:background 0.3s;
}
#buttons button.active { background:#666; color:#ff0; }
.legend-panel {
  position:absolute;
  bottom:20px;
  right:20px;
  background:rgba(255,255,255,0.9);
  color:#222;
  padding:10px 15px;
  border-radius:8px;
  font-weight:600; font-size:14px;
  box-shadow:0 0 10px rgba(0,0,0,0.7);
  max-width:320px;
  line-height:1.4;
  z-index:1400;
  display:none;
}
.legend-item {
  display:flex; align-items:center; margin-bottom:6px;
}
.legend-color {
  width:18px; height:18px; border-radius:50%; margin-right:10px; border:1px solid #999;
}
#tempTableContainer, #humidityTableContainer, #windDetails {
  position: absolute;
  top: 110px;
  left: 10px;
  max-height: px;
  width: 310px; /* 與警告框寬度同步 */
  background: rgba(255,255,255,0.9);
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 0 15px rgba(0,0,0,0.7);
  overflow-y: auto;
  z-index: 1400;
  display: none;
  resize: both;
}
#tempTableContainer table, #humidityTableContainer table, #windDetails table {
  width: 100%;
  border-collapse: collapse;
}
#tempTableContainer th, #tempTableContainer td, #humidityTableContainer th, #humidityTableContainer td,
#windDetails th, #windDetails td {
  border: 1px solid #999;
  padding: 4px 6px;
  text-align: left;
}
#tempTableContainer th, #humidityTableContainer th, #windDetails th {
  background-color: #ddd;
  font-weight: 700;
}
.leaflet-tooltip.weather-label-tooltip {
  background: rgba(0,0,0,0.7);
  color: #ffffa0;
  font-weight: 700;
  font-size: 13px;
  border-radius: 6px;
  padding: 4px 8px;
  box-shadow: 0 0 4px #000;
  white-space: normal;
  text-align: center;
  max-width: 310px;
  min-width: 70px;
  min-height: 34px;
  resize: both;
  overflow: auto;
  display: flex;
  flex-direction: row;
  gap: 8px;
  align-items: center;
  justify-content: center;
}
.station-name {
  font-weight: 700;
}
</style>
</head>
<body>
<div id="header">
  <h4>香港天氣警告</h4>
  <div id="warning">載入中...</div>
</div>
<div id="buttons">
  <button id="btnTemp" class="active">🌡️ 溫度</button>
  <button id="btnHumidity">💧 濕度</button>
  <button id="btnWind">🌬️ 風速</button>
</div>

<div id="tempLegend" class="legend-panel">
  <div><b>氣溫分類</b></div>
  <div class="legend-item"><div class="legend-color" style="background:blue;"></div>低氣溫 (&lt; 20°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:green;"></div>中氣溫 (20-28°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:orange;"></div>高氣溫 (28-33°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:red;"></div>極高氣溫 (&gt; 33°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>無法取得數據</div>
</div>

<div id="humidityLegend" class="legend-panel">
  <div><b>濕度分類</b></div>
  <div class="legend-item"><div class="legend-color" style="background:#cce5ff;"></div>低濕度 (&lt; 25%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#66b0ff;"></div>中濕度 (25-50%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#0066cc;"></div>高濕度 (50-75%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#003366;"></div>極高濕度 (&gt; 75%)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>無法取得數據</div>
</div>

<div id="windLegend" class="legend-panel">
  <div><b>風速分類</b></div>
  <div class="legend-item"><div class="legend-color" style="background:#99ccff;"></div>低風速 (&lt; 20 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#3399ff;"></div>中低風速 (20-40 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#0066cc;"></div>中風速 (40-60 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#004080;"></div>中高風速 (60-100 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#001a33;"></div>高風速 (&gt; 100 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>無法取得數據</div>
</div>

<div id="tempTableContainer">
  <h4>溫度數據</h4>
  <table>
    <thead><tr><th>氣象站</th><th>溫度 (°C)</th></tr></thead>
    <tbody id="tempTableBody"></tbody>
  </table>
</div>

<div id="humidityTableContainer">
  <h4>濕度數據</h4>
  <table>
    <thead><tr><th>氣象站</th><th>濕度 (%)</th></tr></thead>
    <tbody id="humidityTableBody"></tbody>
  </table>
</div>

<div id="windDetails" style="display:none;">
  <h4>風速與陣風數據</h4>
  <table>
    <thead><tr><th>氣象站</th><th>風速 (km/h)</th><th>陣風 (km/h)</th></tr></thead>
    <tbody id="windDataBody"></tbody>
  </table>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([22.3193,114.1694],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap &copy; CARTO', maxZoom:19
}).addTo(map);

const stationCoords = {
  "京士柏":[22.3120,114.1728],"香港天文台":[22.30194,114.17417],"黃竹坑":[22.2494,114.1607],
  "流浮山":[22.4690,113.9836],"大埔":[22.4500,114.1640],"屯門":[22.3926,113.9729],
  "將軍澳":[22.3002,114.2699],"西貢":[22.3831,114.2701],"長洲":[22.2038,114.0308],"赤鱲角":[22.3080,113.9185],
  "青衣":[22.3601,114.1015],"荃灣可觀":[22.3694,114.1017],"荃灣城門谷":[22.3733,114.1297],"香港公園":[22.2793,114.1571],
  "筲箕灣":[22.2805,114.2243],"九龍城":[22.3174,114.1957],"跑馬地":[22.2798,114.1849],
  "黃大仙":[22.3423,114.2017],"觀塘":[22.3141,114.2248],"深水埗":[22.3343,114.1632],
  "啟德跑道公園":[22.3176,114.2234],"元朗公園":[22.4450,114.0380],"大美督":[22.47,114.23]
};

const windStations = {
  "長洲":[22+12/60+4/3600,114+1/60+36/3600],"長洲泳灘":[22+12/60+39/3600,114+1/60+45/3600],
  "北角":[22+17/60+40/3600,114+11/60+59/3600],"沙洲":[22+20/60+45/3600,114+11/60+59/3600],
  "青衣蜆殼油庫":[22+20/60+48/3600,114+5/60+11/3600],"九龍天星碼頭":[22+17/60+35/3600,114+10/60+7/3600],
  "大磨刀":[22+19/60+47/3600,113+58/60+0/3600],"大澳":[22+15/60+22/3600,113+51/60+17/3600],
  "大埔滘":[22+26/60+33/3600,114+11/60+2/3600],"屯門政府合署":[22+23/60+26/3600,113+58/60+36/3600],
  "二東山":[22+15/60+33/3600,113+57/60+51/3600],"塔門東":[22+28/60+6/3600,114+21/60+47/3600],
  "青洲":[22+17/60+6/3600,114+6/60+46/3600],"南丫島":[22+13/60+34/3600,114+6/60+31/3600],
  "大老山":[22+21/60+28/3600,114+13/60+4/3600],"橫瀾島":[22+10/60+56/3600,114+18/60+12/3600],
  "香港國際機場":[22+18/60+34/3600,113+55/60+19/3600],"塔門":[22+28/60+17/3600,114+21/60+38/3600],
  "昂坪":[22+15/60+31/3600,113+54/60+46/3600],"坪洲":[22+17/60+28/3600,114+2/60+36/3600]
};

const openWeatherMapApiKey = 'f19c9c1cfbb572c048a0a99c38f012d2';

let weatherMarkers = [];
let currentLayer = 'temp';

const btnTemp = document.getElementById('btnTemp');
const btnHumidity = document.getElementById('btnHumidity');
const btnWind = document.getElementById('btnWind');
const tempLegend = document.getElementById('tempLegend');
const windLegend = document.getElementById('windLegend');
const humidityLegend = document.getElementById('humidityLegend');
const windDetails = document.getElementById('windDetails');
const humidityTableContainer = document.getElementById('humidityTableContainer');
const tempTableContainer = document.getElementById('tempTableContainer');

btnTemp.onclick = () => switchLayer('temp');
btnHumidity.onclick = () => switchLayer('humidity');
btnWind.onclick = () => switchLayer('wind');

function getColorByTemp(t) {
  if (t == null || isNaN(t)) return 'gray';
  if (t < 20) return 'blue';
  if (t < 28) return 'green';
  if (t < 33) return 'orange';
  return 'red';
}

function getColorByHumidity(h) {
  if (h == null || isNaN(h)) return 'gray';
  if (h < 25) return '#cce5ff';
  if (h < 50) return '#66b0ff';
  if (h < 75) return '#0066cc';
  return '#003366';
}

function getColorByWind(speed) {
  if (speed == null || isNaN(speed)) return 'gray';
  if (speed < 20) return '#99ccff';
  if (speed < 40) return '#3399ff';
  if (speed < 60) return '#0066cc';
  if (speed < 100) return '#004080';
  return '#001a33';
}

function createColoredIcon(color) {
  return L.divIcon({
    className: '',
    html: `<svg height="16" width="16"><circle cx="8" cy="8" r="7" fill="${color}" /></svg>`,
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });
}

function addTempMarker(name, coord, temp, color) {
  const icon = createColoredIcon(color);
  const tooltip = `<div><strong>${name}</strong></div><div>溫度: ${temp} °C</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(tooltip, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

function updateTempList(data) {
  let html = '<h4>溫度數據</h4><table>';
  html += '<thead><tr><th>氣象站</th><th>溫度 (°C)</th></tr></thead><tbody>';
  data.forEach(d => {
    html += `<tr><td>${d.name}</td><td>${d.value}</td></tr>`;
  });
  html += '</tbody></table>';
  tempTableContainer.innerHTML = html;
  tempTableContainer.style.width = window.getComputedStyle(document.getElementById('warning')).width;
  tempTableContainer.style.display = 'block';
}

async function clearAll() {
  while (weatherMarkers.length) {
    const m = weatherMarkers.pop();
    map.removeLayer(m);
  }
}

async function fetchTemperature() {
  clearAll();
  tempLegend.style.display = 'block';
  windLegend.style.display = 'none';
  humidityLegend.style.display = 'none';
  humidityTableContainer.style.display = 'none';
  windDetails.style.display = 'none';
  tempTableContainer.style.display = 'block';

  try {
    const resp = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
    const data = await resp.json();
    const temps = data.temperature.data.map(d => ({ name: d.place, value: d.value }));
    temps.forEach(t => {
      if (stationCoords[t.name]) {
        addTempMarker(t.name, stationCoords[t.name], t.value, getColorByTemp(t.value));
      }
    });
    updateTempList(temps);
  } catch (e) {
    console.error(e);
  }
}

async function fetchHumidity() {
  clearAll();
  tempLegend.style.display = 'none';
  windLegend.style.display = 'none';
  humidityLegend.style.display = 'block';
  humidityTableContainer.style.display = 'block';
  windDetails.style.display = 'none';
  tempTableContainer.style.display = 'none';

  const tbody = document.getElementById('humidityTableBody');
  tbody.innerHTML = '';

  const promises = Object.entries(stationCoords).map(async ([name, coord]) => {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coord[0]}&lon=${coord[1]}&appid=${openWeatherMapApiKey}&units=metric`;
      const resp = await fetch(url);
      const data = await resp.json();
      const hum = data.main?.humidity;
      const color = (hum !== undefined && hum !== null) ? getColorByHumidity(hum) : 'gray';
      addHumidityMarker(name, coord, hum !== undefined ? hum : 'N/A', color);
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>${hum !== undefined ? hum : 'N/A'}</td>`;
      tbody.appendChild(row);
    } catch {
      addHumidityMarker(name, coord, 'N/A', 'gray');
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>N/A</td>`;
      tbody.appendChild(row);
    }
  });

  await Promise.all(promises);
}

function addHumidityMarker(name, coord, humidity, color) {
  const icon = createColoredIcon(color);
  const html = `<div><strong>${name}</strong></div><div>濕度: ${humidity}%</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

async function fetchWind() {
  clearAll();
  tempLegend.style.display = 'none';
  humidityLegend.style.display = 'none';
  humidityTableContainer.style.display = 'none';
  windLegend.style.display = 'block';
  windDetails.style.display = 'block';

  windDetails.querySelector('tbody').innerHTML = '';

  for (const [name, coord] of Object.entries(windStations)) {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coord[0]}&lon=${coord[1]}&appid=${openWeatherMapApiKey}&units=metric`;
      const resp = await fetch(url);
      const data = await resp.json();
      const speed = data.wind?.speed ? (data.wind.speed * 3.6).toFixed(1) : 'N/A';
      const gust = data.wind?.gust ? (data.wind.gust * 3.6).toFixed(1) : 'N/A';
      const color = speed !== 'N/A' ? getColorByWind(parseFloat(speed)) : 'gray';
      addWindMarker(name, coord, speed, gust, color);
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>${speed}</td><td>${gust}</td>`;
      windDetails.querySelector('tbody').appendChild(row);
    } catch (e) {
      addWindMarker(name, coord, 'N/A', 'N/A', 'gray');
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>N/A</td><td>N/A</td>`;
      windDetails.querySelector('tbody').appendChild(row);
    }
  }
}

function addWindMarker(name, coord, speed, gust, color) {
  const icon = createColoredIcon(color);
  const html = `<div><strong>${name}</strong></div><div>風速: ${speed} km/h</div><div>陣風: ${gust} km/h</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

function addMarkerHorizontal(name, coord, val, emoji, color) {
  const icon = createColoredIcon(color);
  const html = `<span class="station-name">${name}</span>` + ((val || emoji) ? `<span class="station-value">${emoji || ''} ${val || ''}</span>` : '');
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: true, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

async function fetchWarning() {
  const warningDiv = document.getElementById('warning');
  try {
    const resp = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc');
    const data = await resp.json();
    const warnings = Object.values(data) || [];
    const active = warnings.filter(w => w.actionCode === 'ISSUE')
      .map(w => `⚠️ ${w.name}${w.type ? ' (' + w.type + ')' : ''} - 發佈: ${w.issueTime.replace('T', ' ').substr(0, 16)}`);
    warningDiv.innerHTML = active.length ? active.join('<br>') : '✅ 暫無天氣警告';
  } catch (e) {
    warningDiv.textContent = '❌ 警告讀取失敗';
    console.error(e);
  }
}

async function switchLayer(layer) {
  if (layer === currentLayer) return;
  currentLayer = layer;
  document.querySelectorAll('#buttons button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn' + layer.charAt(0).toUpperCase() + layer.slice(1)).classList.add('active');
  if (layer === 'temp') await fetchTemperature();
  else if (layer === 'humidity') await fetchHumidity();
  else if (layer === 'wind') await fetchWind();
}

tempLegend.style.display = 'block';
fetchWarning();
fetchTemperature();

setInterval(() => {
  fetchWarning();
  if (currentLayer === 'temp') fetchTemperature();
  else if (currentLayer === 'humidity') fetchHumidity();
  else if (currentLayer === 'wind') fetchWind();
}, 10 * 60 * 1000);
</script>
</body>
</html>
