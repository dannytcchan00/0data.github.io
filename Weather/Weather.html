<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é¦™æ¸¯æ°£è±¡å¤šåŠŸèƒ½åœ°åœ–</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html,body { margin:0; padding:0; height:100%; background:#121212; font-family:Arial,sans-serif; }
#map { width: 100vw; height: 100vh; }
#header {
  position:absolute; top:10px; left:10px; z-index:1300;
  background:rgba(255,255,255,0.9); padding:6px 10px;
  border-radius:8px; font-weight:700; font-size:14px; color:#222;
  box-shadow:0 0 10px rgba(0,0,0,0.7); max-width:320px; min-width:150px;
  overflow-wrap:break-word; line-height:1.2; word-break: break-word;
  width: 320px;
}
#warning { margin:4px 0; }
#buttons {
  position:absolute; top:10px; right:10px; z-index:1300;
  display:flex; gap:8px;
}
#buttons button {
  background:#333; color:#fff; border:none; padding:6px 12px; border-radius:5px;
  cursor:pointer; font-weight:600; font-size:13px;
  transition:background 0.3s;
}
#buttons button.active { background:#666; color:#ff0; }
.legend-panel {
  position:absolute;
  bottom:20px;
  right:20px;
  background:rgba(255,255,255,0.9);
  color:#222;
  padding:10px 15px;
  border-radius:8px;
  font-weight:600; font-size:14px;
  box-shadow:0 0 10px rgba(0,0,0,0.7);
  max-width:320px;
  line-height:1.4;
  z-index:1400;
  display:none;
}
.legend-item {
  display:flex; align-items:center; margin-bottom:6px;
}
.legend-color {
  width:18px; height:18px; border-radius:50%; margin-right:10px; border:1px solid #999;
}
#tempTableContainer, #humidityTableContainer, #windDetails {
  position: absolute;
  top: 110px;
  left: 10px;
  max-height: px;
  width: 310px; /* èˆ‡è­¦å‘Šæ¡†å¯¬åº¦åŒæ­¥ */
  background: rgba(255,255,255,0.9);
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 0 15px rgba(0,0,0,0.7);
  overflow-y: auto;
  z-index: 1400;
  display: none;
  resize: both;
}
#tempTableContainer table, #humidityTableContainer table, #windDetails table {
  width: 100%;
  border-collapse: collapse;
}
#tempTableContainer th, #tempTableContainer td, #humidityTableContainer th, #humidityTableContainer td,
#windDetails th, #windDetails td {
  border: 1px solid #999;
  padding: 4px 6px;
  text-align: left;
}
#tempTableContainer th, #humidityTableContainer th, #windDetails th {
  background-color: #ddd;
  font-weight: 700;
}
.leaflet-tooltip.weather-label-tooltip {
  background: rgba(0,0,0,0.7);
  color: #ffffa0;
  font-weight: 700;
  font-size: 13px;
  border-radius: 6px;
  padding: 4px 8px;
  box-shadow: 0 0 4px #000;
  white-space: normal;
  text-align: center;
  max-width: 310px;
  min-width: 70px;
  min-height: 34px;
  resize: both;
  overflow: auto;
  display: flex;
  flex-direction: row;
  gap: 8px;
  align-items: center;
  justify-content: center;
}
.station-name {
  font-weight: 700;
}
</style>
</head>
<body>
<div id="header">
  <h4>é¦™æ¸¯å¤©æ°£è­¦å‘Š</h4>
  <div id="warning">è¼‰å…¥ä¸­...</div>
</div>
<div id="buttons">
  <button id="btnTemp" class="active">ğŸŒ¡ï¸ æº«åº¦</button>
  <button id="btnHumidity">ğŸ’§ æ¿•åº¦</button>
  <button id="btnWind">ğŸŒ¬ï¸ é¢¨é€Ÿ</button>
</div>

<div id="tempLegend" class="legend-panel">
  <div><b>æ°£æº«åˆ†é¡</b></div>
  <div class="legend-item"><div class="legend-color" style="background:blue;"></div>ä½æ°£æº« (&lt; 20Â°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:green;"></div>ä¸­æ°£æº« (20-28Â°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:orange;"></div>é«˜æ°£æº« (28-33Â°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:red;"></div>æ¥µé«˜æ°£æº« (&gt; 33Â°C)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>ç„¡æ³•å–å¾—æ•¸æ“š</div>
</div>

<div id="humidityLegend" class="legend-panel">
  <div><b>æ¿•åº¦åˆ†é¡</b></div>
  <div class="legend-item"><div class="legend-color" style="background:#cce5ff;"></div>ä½æ¿•åº¦ (&lt; 25%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#66b0ff;"></div>ä¸­æ¿•åº¦ (25-50%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#0066cc;"></div>é«˜æ¿•åº¦ (50-75%)</div>
  <div class="legend-item"><div class="legend-color" style="background:#003366;"></div>æ¥µé«˜æ¿•åº¦ (&gt; 75%)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>ç„¡æ³•å–å¾—æ•¸æ“š</div>
</div>

<div id="windLegend" class="legend-panel">
  <div><b>é¢¨é€Ÿåˆ†é¡</b></div>
  <div class="legend-item"><div class="legend-color" style="background:#99ccff;"></div>ä½é¢¨é€Ÿ (&lt; 20 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#3399ff;"></div>ä¸­ä½é¢¨é€Ÿ (20-40 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#0066cc;"></div>ä¸­é¢¨é€Ÿ (40-60 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#004080;"></div>ä¸­é«˜é¢¨é€Ÿ (60-100 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:#001a33;"></div>é«˜é¢¨é€Ÿ (&gt; 100 km/h)</div>
  <div class="legend-item"><div class="legend-color" style="background:gray;"></div>ç„¡æ³•å–å¾—æ•¸æ“š</div>
</div>

<div id="tempTableContainer">
  <h4>æº«åº¦æ•¸æ“š</h4>
  <table>
    <thead><tr><th>æ°£è±¡ç«™</th><th>æº«åº¦ (Â°C)</th></tr></thead>
    <tbody id="tempTableBody"></tbody>
  </table>
</div>

<div id="humidityTableContainer">
  <h4>æ¿•åº¦æ•¸æ“š</h4>
  <table>
    <thead><tr><th>æ°£è±¡ç«™</th><th>æ¿•åº¦ (%)</th></tr></thead>
    <tbody id="humidityTableBody"></tbody>
  </table>
</div>

<div id="windDetails" style="display:none;">
  <h4>é¢¨é€Ÿèˆ‡é™£é¢¨æ•¸æ“š</h4>
  <table>
    <thead><tr><th>æ°£è±¡ç«™</th><th>é¢¨é€Ÿ (km/h)</th><th>é™£é¢¨ (km/h)</th></tr></thead>
    <tbody id="windDataBody"></tbody>
  </table>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([22.3193,114.1694],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap &copy; CARTO', maxZoom:19
}).addTo(map);

const stationCoords = {
  "äº¬å£«æŸ":[22.3120,114.1728],"é¦™æ¸¯å¤©æ–‡å°":[22.30194,114.17417],"é»ƒç«¹å‘":[22.2494,114.1607],
  "æµæµ®å±±":[22.4690,113.9836],"å¤§åŸ”":[22.4500,114.1640],"å±¯é–€":[22.3926,113.9729],
  "å°‡è»æ¾³":[22.3002,114.2699],"è¥¿è²¢":[22.3831,114.2701],"é•·æ´²":[22.2038,114.0308],"èµ¤é±²è§’":[22.3080,113.9185],
  "é’è¡£":[22.3601,114.1015],"èƒç£å¯è§€":[22.3694,114.1017],"èƒç£åŸé–€è°·":[22.3733,114.1297],"é¦™æ¸¯å…¬åœ’":[22.2793,114.1571],
  "ç­²ç®•ç£":[22.2805,114.2243],"ä¹é¾åŸ":[22.3174,114.1957],"è·‘é¦¬åœ°":[22.2798,114.1849],
  "é»ƒå¤§ä»™":[22.3423,114.2017],"è§€å¡˜":[22.3141,114.2248],"æ·±æ°´åŸ—":[22.3343,114.1632],
  "å•Ÿå¾·è·‘é“å…¬åœ’":[22.3176,114.2234],"å…ƒæœ—å…¬åœ’":[22.4450,114.0380],"å¤§ç¾ç£":[22.47,114.23]
};

const windStations = {
  "é•·æ´²":[22+12/60+4/3600,114+1/60+36/3600],"é•·æ´²æ³³ç˜":[22+12/60+39/3600,114+1/60+45/3600],
  "åŒ—è§’":[22+17/60+40/3600,114+11/60+59/3600],"æ²™æ´²":[22+20/60+45/3600,114+11/60+59/3600],
  "é’è¡£èœ†æ®¼æ²¹åº«":[22+20/60+48/3600,114+5/60+11/3600],"ä¹é¾å¤©æ˜Ÿç¢¼é ­":[22+17/60+35/3600,114+10/60+7/3600],
  "å¤§ç£¨åˆ€":[22+19/60+47/3600,113+58/60+0/3600],"å¤§æ¾³":[22+15/60+22/3600,113+51/60+17/3600],
  "å¤§åŸ”æ»˜":[22+26/60+33/3600,114+11/60+2/3600],"å±¯é–€æ”¿åºœåˆç½²":[22+23/60+26/3600,113+58/60+36/3600],
  "äºŒæ±å±±":[22+15/60+33/3600,113+57/60+51/3600],"å¡”é–€æ±":[22+28/60+6/3600,114+21/60+47/3600],
  "é’æ´²":[22+17/60+6/3600,114+6/60+46/3600],"å—ä¸«å³¶":[22+13/60+34/3600,114+6/60+31/3600],
  "å¤§è€å±±":[22+21/60+28/3600,114+13/60+4/3600],"æ©«ç€¾å³¶":[22+10/60+56/3600,114+18/60+12/3600],
  "é¦™æ¸¯åœ‹éš›æ©Ÿå ´":[22+18/60+34/3600,113+55/60+19/3600],"å¡”é–€":[22+28/60+17/3600,114+21/60+38/3600],
  "æ˜‚åª":[22+15/60+31/3600,113+54/60+46/3600],"åªæ´²":[22+17/60+28/3600,114+2/60+36/3600]
};

const openWeatherMapApiKey = 'f19c9c1cfbb572c048a0a99c38f012d2';

let weatherMarkers = [];
let currentLayer = 'temp';

const btnTemp = document.getElementById('btnTemp');
const btnHumidity = document.getElementById('btnHumidity');
const btnWind = document.getElementById('btnWind');
const tempLegend = document.getElementById('tempLegend');
const windLegend = document.getElementById('windLegend');
const humidityLegend = document.getElementById('humidityLegend');
const windDetails = document.getElementById('windDetails');
const humidityTableContainer = document.getElementById('humidityTableContainer');
const tempTableContainer = document.getElementById('tempTableContainer');

btnTemp.onclick = () => switchLayer('temp');
btnHumidity.onclick = () => switchLayer('humidity');
btnWind.onclick = () => switchLayer('wind');

function getColorByTemp(t) {
  if (t == null || isNaN(t)) return 'gray';
  if (t < 20) return 'blue';
  if (t < 28) return 'green';
  if (t < 33) return 'orange';
  return 'red';
}

function getColorByHumidity(h) {
  if (h == null || isNaN(h)) return 'gray';
  if (h < 25) return '#cce5ff';
  if (h < 50) return '#66b0ff';
  if (h < 75) return '#0066cc';
  return '#003366';
}

function getColorByWind(speed) {
  if (speed == null || isNaN(speed)) return 'gray';
  if (speed < 20) return '#99ccff';
  if (speed < 40) return '#3399ff';
  if (speed < 60) return '#0066cc';
  if (speed < 100) return '#004080';
  return '#001a33';
}

function createColoredIcon(color) {
  return L.divIcon({
    className: '',
    html: `<svg height="16" width="16"><circle cx="8" cy="8" r="7" fill="${color}" /></svg>`,
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });
}

function addTempMarker(name, coord, temp, color) {
  const icon = createColoredIcon(color);
  const tooltip = `<div><strong>${name}</strong></div><div>æº«åº¦: ${temp} Â°C</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(tooltip, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

function updateTempList(data) {
  let html = '<h4>æº«åº¦æ•¸æ“š</h4><table>';
  html += '<thead><tr><th>æ°£è±¡ç«™</th><th>æº«åº¦ (Â°C)</th></tr></thead><tbody>';
  data.forEach(d => {
    html += `<tr><td>${d.name}</td><td>${d.value}</td></tr>`;
  });
  html += '</tbody></table>';
  tempTableContainer.innerHTML = html;
  tempTableContainer.style.width = window.getComputedStyle(document.getElementById('warning')).width;
  tempTableContainer.style.display = 'block';
}

async function clearAll() {
  while (weatherMarkers.length) {
    const m = weatherMarkers.pop();
    map.removeLayer(m);
  }
}

async function fetchTemperature() {
  clearAll();
  tempLegend.style.display = 'block';
  windLegend.style.display = 'none';
  humidityLegend.style.display = 'none';
  humidityTableContainer.style.display = 'none';
  windDetails.style.display = 'none';
  tempTableContainer.style.display = 'block';

  try {
    const resp = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
    const data = await resp.json();
    const temps = data.temperature.data.map(d => ({ name: d.place, value: d.value }));
    temps.forEach(t => {
      if (stationCoords[t.name]) {
        addTempMarker(t.name, stationCoords[t.name], t.value, getColorByTemp(t.value));
      }
    });
    updateTempList(temps);
  } catch (e) {
    console.error(e);
  }
}

async function fetchHumidity() {
  clearAll();
  tempLegend.style.display = 'none';
  windLegend.style.display = 'none';
  humidityLegend.style.display = 'block';
  humidityTableContainer.style.display = 'block';
  windDetails.style.display = 'none';
  tempTableContainer.style.display = 'none';

  const tbody = document.getElementById('humidityTableBody');
  tbody.innerHTML = '';

  const promises = Object.entries(stationCoords).map(async ([name, coord]) => {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coord[0]}&lon=${coord[1]}&appid=${openWeatherMapApiKey}&units=metric`;
      const resp = await fetch(url);
      const data = await resp.json();
      const hum = data.main?.humidity;
      const color = (hum !== undefined && hum !== null) ? getColorByHumidity(hum) : 'gray';
      addHumidityMarker(name, coord, hum !== undefined ? hum : 'N/A', color);
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>${hum !== undefined ? hum : 'N/A'}</td>`;
      tbody.appendChild(row);
    } catch {
      addHumidityMarker(name, coord, 'N/A', 'gray');
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>N/A</td>`;
      tbody.appendChild(row);
    }
  });

  await Promise.all(promises);
}

function addHumidityMarker(name, coord, humidity, color) {
  const icon = createColoredIcon(color);
  const html = `<div><strong>${name}</strong></div><div>æ¿•åº¦: ${humidity}%</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

async function fetchWind() {
  clearAll();
  tempLegend.style.display = 'none';
  humidityLegend.style.display = 'none';
  humidityTableContainer.style.display = 'none';
  windLegend.style.display = 'block';
  windDetails.style.display = 'block';

  windDetails.querySelector('tbody').innerHTML = '';

  for (const [name, coord] of Object.entries(windStations)) {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coord[0]}&lon=${coord[1]}&appid=${openWeatherMapApiKey}&units=metric`;
      const resp = await fetch(url);
      const data = await resp.json();
      const speed = data.wind?.speed ? (data.wind.speed * 3.6).toFixed(1) : 'N/A';
      const gust = data.wind?.gust ? (data.wind.gust * 3.6).toFixed(1) : 'N/A';
      const color = speed !== 'N/A' ? getColorByWind(parseFloat(speed)) : 'gray';
      addWindMarker(name, coord, speed, gust, color);
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>${speed}</td><td>${gust}</td>`;
      windDetails.querySelector('tbody').appendChild(row);
    } catch (e) {
      addWindMarker(name, coord, 'N/A', 'N/A', 'gray');
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td><td>N/A</td><td>N/A</td>`;
      windDetails.querySelector('tbody').appendChild(row);
    }
  }
}

function addWindMarker(name, coord, speed, gust, color) {
  const icon = createColoredIcon(color);
  const html = `<div><strong>${name}</strong></div><div>é¢¨é€Ÿ: ${speed} km/h</div><div>é™£é¢¨: ${gust} km/h</div>`;
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: false, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

function addMarkerHorizontal(name, coord, val, emoji, color) {
  const icon = createColoredIcon(color);
  const html = `<span class="station-name">${name}</span>` + ((val || emoji) ? `<span class="station-value">${emoji || ''} ${val || ''}</span>` : '');
  const marker = L.marker(coord, { icon }).addTo(map);
  marker.bindTooltip(html, { permanent: true, direction: 'top', offset: [0, -12], className: 'leaflet-tooltip weather-label-tooltip' });
  weatherMarkers.push(marker);
}

async function fetchWarning() {
  const warningDiv = document.getElementById('warning');
  try {
    const resp = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc');
    const data = await resp.json();
    const warnings = Object.values(data) || [];
    const active = warnings.filter(w => w.actionCode === 'ISSUE')
      .map(w => `âš ï¸ ${w.name}${w.type ? ' (' + w.type + ')' : ''} - ç™¼ä½ˆ: ${w.issueTime.replace('T', ' ').substr(0, 16)}`);
    warningDiv.innerHTML = active.length ? active.join('<br>') : 'âœ… æš«ç„¡å¤©æ°£è­¦å‘Š';
  } catch (e) {
    warningDiv.textContent = 'âŒ è­¦å‘Šè®€å–å¤±æ•—';
    console.error(e);
  }
}

async function switchLayer(layer) {
  if (layer === currentLayer) return;
  currentLayer = layer;
  document.querySelectorAll('#buttons button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn' + layer.charAt(0).toUpperCase() + layer.slice(1)).classList.add('active');
  if (layer === 'temp') await fetchTemperature();
  else if (layer === 'humidity') await fetchHumidity();
  else if (layer === 'wind') await fetchWind();
}

tempLegend.style.display = 'block';
fetchWarning();
fetchTemperature();

setInterval(() => {
  fetchWarning();
  if (currentLayer === 'temp') fetchTemperature();
  else if (currentLayer === 'humidity') fetchHumidity();
  else if (currentLayer === 'wind') fetchWind();
}, 10 * 60 * 1000);
</script>
</body>
</html>
